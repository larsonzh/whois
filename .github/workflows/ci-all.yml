name: CI - Combined Matrix (Pacing & Strict Version)

on:
  push:
    branches: [ master ]
    paths:
      - 'src/**'
      - 'include/**'
      - 'tools/remote/**'
      - 'Makefile'
      - '.github/workflows/**'
  pull_request:
    branches: [ master ]
    paths:
      - 'src/**'
      - 'include/**'
      - 'tools/remote/**'
      - 'Makefile'
      - '.github/workflows/**'

jobs:
  build-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        jobType: [ pacing-nonzero, pacing-zero, strict-version ]
    env:
      RB_HOST: ${{ secrets.WHOIS_RB_HOST }}
      RB_USER: ${{ secrets.WHOIS_RB_USER }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare SSH key
        shell: bash
        env:
          RB_KEY: ${{ secrets.WHOIS_RB_KEY }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "$RB_KEY" > ~/.ssh/whois_ci_key
          chmod 600 ~/.ssh/whois_ci_key

      - name: Run matrix job
        shell: bash
        run: |
          set -euo pipefail
          case "${{ matrix.jobType }}" in
            pacing-nonzero)
              echo "Running pacing assertion: nonzero"
              bash tools/remote/remote_build_and_test.sh -H "$RB_HOST" -u "$RB_USER" -k "$HOME/.ssh/whois_ci_key" -r 1 -P 1 -a '--retry-metrics --selftest-fail-first-attempt' -M nonzero -t x86_64
              ;;
            pacing-zero)
              echo "Running pacing assertion: zero"
              bash tools/remote/remote_build_and_test.sh -H "$RB_HOST" -u "$RB_USER" -k "$HOME/.ssh/whois_ci_key" -r 1 -P 1 -a '--retry-metrics --selftest-fail-first-attempt --pacing-disable' -M zero -t x86_64
              ;;
            strict-version)
              echo "Running strict version build (no tests)"
              export WHOIS_STRICT_VERSION=1
              bash tools/remote/remote_build_and_test.sh -H "$RB_HOST" -u "$RB_USER" -k "$HOME/.ssh/whois_ci_key" -r 0 -P 1 -t x86_64
              ;;
            *)
              echo "Unknown matrix jobType: ${{ matrix.jobType }}" >&2; exit 1;
              ;;
          esac

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.jobType }}-artifacts
          path: |
            out/artifacts/**
