# whois v3.2.9

聚焦 DNS Phase 2/3 收尾、DNS 健康记忆与调试可观测性，将当前 DNS 实现标记为新的黄金基线。
Focus on DNS Phase 2/3 wrap-up, DNS health memory and observability, turning the current DNS stack into the new golden baseline.

中文概要：
- DNS Phase 2/3 收尾：以 `wc_dns` + lookup 为中心，固化“候选生成 → 负缓存 → 候选排序 → 回退层”整体设计，并通过 `[DNS-CAND]` / `[DNS-FALLBACK]` / `[DNS-CACHE]` / `[DNS-HEALTH]` 将关键路径暴露到 stderr，默认仅在 `--debug` 或 `--retry-metrics` 下输出，兼容既有 stdout 契约。
- 进程级 DNS 缓存统计：`--dns-cache-stats` 在进程退出时输出一行 `[DNS-CACHE-SUM] hits=<n> neg_hits=<n> misses=<n>`，用于观察正向/负向缓存命中率和未命中数量，不改变解析或回退策略，可安全用于生产环境调试。
- DNS 健康记忆（Phase 3）：为每个 `host+family` 维护轻量健康状态（连续失败计数、短期惩罚窗口等），通过 `[DNS-HEALTH]` 日志暴露当前健康度，在候选排序中对“已证明不健康”的家族轻量降权，减少在被墙 IPv4/IPv6 段上的重复超时。
- 自测与 DNS 调试 quickstart：在以 `-DWHOIS_LOOKUP_SELFTEST` 编译且加 `--selftest` 时，新增的 `[LOOKUP_SELFTEST]` 行会总结本次自测中的 DNS 候选、健康记忆与回退路径，用于在远程冒烟日志中快速 eyeball；`USAGE_CN/EN` 与 `OPERATIONS_CN/EN` 新增了推荐命令 `whois-x86_64 --debug --retry-metrics --dns-cache-stats [--selftest] 8.8.8.8` 的 quickstart 章节。
- 运维与脚本文档补完：`tools/remote/README_*.md` 补充了在开启 DNS 调试与自测时，`smoke_test.log` 中出现 `[DNS-CAND]` / `[DNS-FALLBACK]` / `[DNS-CACHE]` / `[DNS-HEALTH]` / `[LOOKUP_SELFTEST]` 的预期行为说明；`RELEASE_NOTES.md`、USAGE/OPERATIONS 文档中的版本标注统一到具体版本（去掉 `+`），便于今后追踪变更。
- 版本基线更新：核心代码版本号升级为 `3.2.9`，README 顶部展示同步更新，本版本被视为 DNS 策略与调试可观测性的“新 golden baseline”。

English summary:
- DNS Phase 2/3 completion: the `wc_dns` + lookup stack is now treated as the canonical baseline for DNS candidate generation, negative cache, candidate ordering and layered fallbacks. Key steps are exposed via `[DNS-CAND]`, `[DNS-FALLBACK]`, `[DNS-CACHE]` and the new `[DNS-HEALTH]` tag, emitted only when `--debug` or `--retry-metrics` is enabled, keeping existing stdout contracts intact.
- Process-level DNS cache stats: `--dns-cache-stats` prints a single `[DNS-CACHE-SUM] hits=<n> neg_hits=<n> misses=<n>` line at process exit via `atexit`, giving operators a rough view of positive/negative cache hit rates and misses without changing any resolution or fallback behavior.
- DNS health memory (Phase 3): `wc_dns` now maintains a lightweight health state per `host+family` (consecutive failures and a short penalty window). `[DNS-HEALTH]` logs expose this state, and candidate ordering biases towards “healthier” families without ever dropping candidates, reducing repeated timeouts on clearly broken IPv4/IPv6 paths.
- Selftest & DNS debug quickstart: when built with `-DWHOIS_LOOKUP_SELFTEST` and run with `--selftest`, new `[LOOKUP_SELFTEST]` lines summarize DNS candidates, health memory and fallback paths for quick eyeballing in remote smoke logs. `USAGE_CN/EN` and `OPERATIONS_CN/EN` now feature a DNS debug quickstart recommending `whois-x86_64 --debug --retry-metrics --dns-cache-stats [--selftest] 8.8.8.8` and explaining the meaning of DNS-related stderr tags.
- Ops scripts & docs alignment: `tools/remote/README_*.md` call out `[DNS-CAND]` / `[DNS-FALLBACK]` / `[DNS-CACHE]` / `[DNS-HEALTH]` / `[LOOKUP_SELFTEST]` as expected content in `smoke_test.log` when DNS debugging or selftests are enabled. Version annotations in `RELEASE_NOTES.md` and USAGE/OPERATIONS docs are normalized to concrete versions (no trailing `+`), making historical tracking easier.
- Version baseline: bump core version to `3.2.9` and update the top-level README banner; v3.2.9 is considered the new golden baseline for DNS behavior and observability.

---
## DNS 调试 quickstart / DNS debug quickstart

推荐用于 eyeball DNS 候选、缓存与健康记忆输出的命令：
Recommended command for eyeballing DNS candidates, cache, and health memory:

```bash
whois-x86_64 --debug --retry-metrics --dns-cache-stats --selftest 8.8.8.8
```

要点 / Notes:
- `[DNS-CAND]`：展示本次解析得到的候选服务器（含 IPv4/IPv6 家族、优先级等），用于确认候选生成逻辑是否符合预期。
- `[DNS-FALLBACK]`：标记发生回退的场景（如从 AI_ADDRCONFIG 失败回退到已知 RIR IPv4，或在连接失败后切换家族），帮助分析“为什么连到了这个 IP”。
- `[DNS-CACHE]`：展示命中或写入 DNS 缓存（包括负缓存）的操作，用于确认相同查询在同一进程中的加速效果。
- `[DNS-HEALTH]`：展示每个 `host+family` 的当前健康状态（如连续失败次数、是否处于 penalty 窗口），用于判断某个族是否被暂时降权。
- `[DNS-CACHE-SUM]`：在进程退出时输出的聚合统计行，仅一行；配合上方标签可帮助估算缓存带来的收益。
- `[LOOKUP_SELFTEST]`：仅在自测模式下出现，对本轮自测路径做高度概括，方便在长日志中快速定位。

---
## 下载 / Downloads

- 静态多架构 / Static multi-arch (GitHub Release v3.2.9):
  - [whois-aarch64](https://github.com/larsonzh/whois/releases/download/v3.2.9/whois-aarch64)
  - [whois-armv7](https://github.com/larsonzh/whois/releases/download/v3.2.9/whois-armv7)
  - [whois-loongarch64](https://github.com/larsonzh/whois/releases/download/v3.2.9/whois-loongarch64)
  - [whois-mips64el](https://github.com/larsonzh/whois/releases/download/v3.2.9/whois-mips64el)
  - [whois-mipsel](https://github.com/larsonzh/whois/releases/download/v3.2.9/whois-mipsel)
  - [whois-x86](https://github.com/larsonzh/whois/releases/download/v3.2.9/whois-x86)
  - [whois-x86_64](https://github.com/larsonzh/whois/releases/download/v3.2.9/whois-x86_64)

- CI glibc 构建 / CI glibc build:
  - [whois-x86_64-gnu](https://github.com/larsonzh/whois/releases/download/v3.2.9/whois-x86_64-gnu)

- 校验 / Checksums:
  - [SHA256SUMS.txt](https://github.com/larsonzh/whois/releases/download/v3.2.9/SHA256SUMS.txt)

---
## 使用提示 / Guidance

DNS 调试与自测示例 / DNS debugging and selftest examples:

```bash
# 带 DNS 调试与缓存统计的基础查询
whois-x86_64 --debug --retry-metrics --dns-cache-stats 8.8.8.8

# 启用 lookup 自测（需以 -DWHOIS_LOOKUP_SELFTEST 编译）
whois-x86_64 --debug --retry-metrics --dns-cache-stats --selftest 8.8.8.8

# 偏向 IPv6 的 DNS 候选选择（示例）
whois-x86_64 --debug --retry-metrics --dns-cache-stats --prefer-ipv6 8.8.8.8
```

---
## 致谢 / Acknowledgements

感谢在 DNS Phase 2/3 期间参与设计讨论、提供测试环境与日志样本的同学，本版本将 DNS 行为与调试可观测性提升到了对后续演进更友好的“黄金基线”状态。
Thanks to everyone who contributed design feedback, test environments and real-world logs during DNS Phase 2/3; this release establishes a more robust golden baseline for future DNS evolution and troubleshooting.
