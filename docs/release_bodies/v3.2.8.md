# whois v3.2.8

聚焦“三跳模拟 + 重试指标可视化 + 架构差异说明”与发布辅助脚本增强。
Focus on three-hop simulation, retry metrics visualization, architecture-specific errno variance, and release helper script enhancements.

中文概要：
- DNS 第一阶段（服务器解析）改进：基于 `AI_ADDRCONFIG` 的解析；IPv4/IPv6 家族控制（仅/优先）；多候选去重与上限；解析/连不通时回退到已知 RIR IPv4；统一 `@ <ip|unknown>` 显示真实连接端点。
- 稳定三跳：`apnic → iana → arin` 通过 `--selftest-force-iana-pivot` 实现“一次性 IANA 强制跳”，后续遵循真实 referral，保证链路可复现。
- 失败注入：中间跳（IANA）与最终跳（ARIN）可用黑洞标志分别模拟超时：`--selftest-blackhole-iana` / `--selftest-blackhole-arin`；保持首/尾行输出契约不变。
- 重试指标：结合 `--retry-metrics -t 3 -r 0`，多架构 attempts≈7（前两次成功、后续超时），p95≈3s；`sleep_ms=0` 验证节流禁用路径；为后续调优提供基线。
- 多目录同步：远程脚本 `-s '<dir1>;<dir2>'` 支持分号分隔多目标同步，便于同时更新主仓与镜像仓。
- 冒烟超时策略：指标运行延长至 45s（SIGINT→5s→SIGKILL）避免截断 `[RETRY-METRICS]`；普通模式仍为 8s，保持快速反馈。
- Errno 差异：连接超时在常见架构为 `errno=110 (ETIMEDOUT)`，在 MIPS/MIPS64 交叉产物下为数值 145（同一符号常量的架构特定编号），逻辑按符号匹配不受影响。
- 黄金样例：下方多架构片段作为后续性能与回归的参考样本。

English summary:
- DNS phase‑1 (server resolution): `AI_ADDRCONFIG`-aware resolution; IPv4/IPv6 family controls (only/prefer); de‑dup & cap candidates; fallback to known RIR IPv4 on resolution/connectivity failures; unify `@ <ip|unknown>` to reflect the actual connected endpoint.
- Stable three-hop: `apnic → iana → arin` chain via one-time pivot flag `--selftest-force-iana-pivot` ensuring only the first hop is forced through IANA.
- Failure injection: middle hop (`--selftest-blackhole-iana`) and final hop (`--selftest-blackhole-arin`) deterministic timeouts preserve header/tail contract.
- Retry metrics: with `--retry-metrics -t 3 -r 0` we see ~7 attempts (first two succeed, remaining time out), p95 ≈ 3s, `sleep_ms=0` validating pacing-disabled path.
- Multi-directory sync: remote script accepts semicolon-separated targets for artifact distribution to multiple local mirrors.
- Metrics-aware smoke timeout: extended to 45s for metric runs (SIGINT then SIGKILL) preventing truncated aggregates; regular runs remain 8s.
- Errno numeric variance: `ETIMEDOUT` is 110 on most architectures, 145 on MIPS/MIPS64; code relies on symbolic `ETIMEDOUT`, not numeric value.
- Golden sample: multi-arch log excerpt below for future regression and performance comparisons.

---
## 多架构重试指标片段 / Multi-arch retry metrics excerpt

```
[RETRY-METRICS-INSTANT] attempt=1 success=1 latency_ms=185 total_attempts=1
[RETRY-METRICS-INSTANT] attempt=2 success=1 latency_ms=236 total_attempts=2
Error: Query failed for 8.8.8.8 (connect timeout, errno=110)
[RETRY-METRICS] attempts=7 successes=2 failures=5 min_ms=185 max_ms=3009 avg_ms=2206.7 p95_ms=3009 sleep_ms=0
[RETRY-ERRORS] timeouts=5 refused=0 net_unreach=0 host_unreach=0 addr_na=0 interrupted=0 other=0
---
Error: Query failed for 8.8.8.8 (connect timeout, errno=145)  # MIPS/MIPS64 variant of ETIMEDOUT
[RETRY-METRICS] attempts=7 successes=2 failures=5 min_ms=210 max_ms=3006 avg_ms=2231.7 p95_ms=3006 sleep_ms=0
[RETRY-ERRORS] timeouts=5 refused=0 net_unreach=0 host_unreach=0 addr_na=0 interrupted=0 other=0
```

关键观察 / Key observations:
- 前两次成功尝试对应“起始服务器 + IANA 枢纽跳”；后续针对 ARIN 的尝试在黑洞场景下超时。
- 失败分类一致：仅 `timeouts` 递增，其它类别保持 0。
- errno 数值差异不影响逻辑分类，代码按符号常量匹配。
- First two successful attempts correspond to initial server and IANA pivot; subsequent attempts target ARIN and time out (blackhole scenario).
- Consistent failure classification: only `timeouts` increment; other categories remain zero.
- Numeric errno difference does not alter classification logic; mapping uses the symbolic constant.

---
## 变更 / Changes

CN:
- 新增三跳与黑洞注入自测标志；保持输出契约与既有脚本兼容。
- 文档（README / RELEASE_NOTES / OPERATIONS_CN/EN）补充三跳用法、指标释义与 errno 差异说明。
- 远程脚本多目录同步与指标超时策略记录更新。

EN:
- Added selftest flags enabling stable three-hop and deterministic hop timeouts.
- Updated docs (README / RELEASE_NOTES / OPERATIONS_CN/EN) with usage, metric interpretation, errno mapping.
- Remote script notes updated for multi-sync and metrics-aware timeout policy.

---
## 下载 / Downloads

- 静态多架构 / Static multi-arch (GitHub Release v3.2.8):
  - [whois-aarch64](https://github.com/larsonzh/whois/releases/download/v3.2.8/whois-aarch64)
  - [whois-armv7](https://github.com/larsonzh/whois/releases/download/v3.2.8/whois-armv7)
  - [whois-loongarch64](https://github.com/larsonzh/whois/releases/download/v3.2.8/whois-loongarch64)
  - [whois-mips64el](https://github.com/larsonzh/whois/releases/download/v3.2.8/whois-mips64el)
  - [whois-mipsel](https://github.com/larsonzh/whois/releases/download/v3.2.8/whois-mipsel)
  - [whois-x86](https://github.com/larsonzh/whois/releases/download/v3.2.8/whois-x86)
  - [whois-x86_64](https://github.com/larsonzh/whois/releases/download/v3.2.8/whois-x86_64)

- CI glibc 构建 / CI glibc build：
  - [whois-x86_64-gnu](https://github.com/larsonzh/whois/releases/download/v3.2.8/whois-x86_64-gnu)

- 校验 / Checksums：
  - [SHA256SUMS.txt](https://github.com/larsonzh/whois/releases/download/v3.2.8/SHA256SUMS.txt)

---
## 使用提示 / Guidance

三跳模拟（最终跳失败示例）:
Three-hop simulation (final-hop failure example):
```
--host apnic --selftest-force-iana-pivot --selftest-blackhole-arin --retry-metrics -t 3 -r 0 --ipv4-only
```
中间跳失败示例：
Middle-hop failure example:
```
--host apnic --selftest-force-iana-pivot --selftest-blackhole-iana --retry-metrics -t 3 -r 0 --ipv4-only
```
多目录同步示例：
Multi-directory sync example:
```
-s '/d/LZProjects/lzispro/release/lzispro/whois;/d/LZProjects/whois/release/lzispro/whois'
```

---
## Errno 映射速查 / Errno mapping quick reference

| Symbol      | Common arches | MIPS/MIPS64 |
|-------------|---------------|-------------|
| ETIMEDOUT   | 110           | 145         |
| ECONNREFUSED| 111           | (arch value)|
| EHOSTUNREACH| 113           | (arch value)|

> 仅在冒烟中观察到 ETIMEDOUT 的数值差异；逻辑按“符号常量”匹配，而非具体数值。
> Only ETIMEDOUT numeric divergence was observed during smoke; logic uses the symbol not the number.

---
## 致谢 / Acknowledgements

感谢多架构 QEMU 验证为重试指标提供一致的基线，并帮助发现不同架构下 errno 数值差异。
Thanks to multi-arch QEMU validation providing consistent retry metric baselines and revealing numeric errno variance across architectures.
